<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì†¡ì–‘ê³  ì˜¤ëŠ˜ ì ì‹¬</title>
    <style>
        body { 
            margin: 0; 
            padding: 20px; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            background-color: #ffffff; 
            color: #37352f; 
        }
        h3 { 
            margin: 0 0 10px 0; 
            font-size: 16px; 
            color: #eb5757; 
            font-weight: 600; 
        }
        .menu { 
            font-size: 14px; 
            line-height: 1.6; 
            white-space: pre-wrap; 
            word-break: keep-all; 
        }
        .info-text { 
            margin-top: 6px; 
            font-size: 12px; 
            color: #888; 
            line-height: 1.5;
            white-space: pre-wrap; 
        }
        .nutri-box {
            margin-top: 0;   
            padding-top: 0;  
            border-top: none; 
        }
    </style>
</head>
<body>
    <div id="container">
        <h3>ğŸ± <span id="date-display">ì˜¤ëŠ˜</span>ì˜ ì ì‹¬</h3>
        <div id="meal-box" class="menu">ë©”ë‰´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        <div id="kcal-box" class="info-text"></div>
        <div id="nutri-box" class="info-text nutri-box"></div>
    </div>

    <script>
        // â–¼â–¼â–¼ ì¸ì¦í‚¤ â–¼â–¼â–¼
        const API_KEY = 'eddddf6d86cc4953a00248d7496c0c8a'; 
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        const EDU_CODE = 'J10'; 
        const SCH_CODE = '7531167'; 
        
        const now = new Date();
        const year = now.getFullYear();
        const month = ('0' + (now.getMonth() + 1)).slice(-2);
        const day = ('0' + now.getDate()).slice(-2);
        const dateStr = `${year}${month}${day}`;
        const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        const dayOfWeek = days[now.getDay()];
        
        document.getElementById('date-display').innerText = `${now.getMonth() + 1}ì›” ${now.getDate()}ì¼(${dayOfWeek})`;

        // í™”ë©´ì— ê·¸ë ¤ì£¼ëŠ” í•¨ìˆ˜ (ì¤‘ë³µ ì œê±°ìš©)
        function renderLunch(menu, kcal, nutri) {
            document.getElementById('meal-box').innerText = menu;
            document.getElementById('kcal-box').innerText = `ì—´ëŸ‰: ${kcal}`;
            document.getElementById('nutri-box').innerText = nutri;
        }

        // [í•µì‹¬] 1. ë¸Œë¼ìš°ì €ì— ì˜¤ëŠ˜ ë©”ë‰´ê°€ ì €ì¥ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
        const cacheKey = `lunch_data_${SCH_CODE}_${dateStr}`; // í‚¤ ì´ë¦„: lunch_data_í•™êµì½”ë“œ_ë‚ ì§œ
        const cachedData = localStorage.getItem(cacheKey);

        if (cachedData) {
            // [A] ì €ì¥ëœ ê²Œ ìˆìœ¼ë©´ -> ì¦‰ì‹œ ë³´ì—¬ì¤Œ (ì†ë„ 0ì´ˆ)
            const data = JSON.parse(cachedData);
            renderLunch(data.menu, data.kcal, data.nutri);
            console.log("ì €ì¥ëœ ê¸‰ì‹ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
        } else {
            // [B] ì—†ìœ¼ë©´ -> êµìœ¡ì²­ ì„œë²„ì—ì„œ ê°€ì ¸ì˜´
            const url = `https://open.neis.go.kr/hub/mealServiceDietInfo?Type=json&KEY=${API_KEY}&ATPT_OFCDC_SC_CODE=${EDU_CODE}&SD_SCHUL_CODE=${SCH_CODE}&MLSV_YMD=${dateStr}&MMEAL_SC_CODE=2`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.mealServiceDietInfo) {
                        const row = data.mealServiceDietInfo[1].row[0];
                        
                        // ë°ì´í„° ê°€ê³µ
                        let menu = row.DDISH_NM.replace(/\([0-9\.]+\)/g, '').replace(/<br\/>/g, '\n');
                        let kcal = row.CAL_INFO;
                        
                        const rawNutri = row.NTR_INFO; 
                        const targets = ['íƒ„ìˆ˜í™”ë¬¼', 'ë‹¨ë°±ì§ˆ', 'ì§€ë°©']; 
                        const filteredNutri = rawNutri.split('<br/>').filter(line => {
                            return targets.some(target => line.includes(target));
                        }).join('\n');

                        // í™”ë©´ ì¶œë ¥
                        renderLunch(menu, kcal, filteredNutri);

                        // [í•µì‹¬] 2. ë‹¤ ê°€ì ¸ì™”ìœ¼ë©´ ë¸Œë¼ìš°ì €ì— ì €ì¥í•´ë‘  (ë‹¤ìŒ ë²ˆ ì ‘ì†ì„ ìœ„í•´)
                        const saveObj = { menu: menu, kcal: kcal, nutri: filteredNutri };
                        localStorage.setItem(cacheKey, JSON.stringify(saveObj));

                    } else {
                        document.getElementById('meal-box').innerText = "ì˜¤ëŠ˜ì€ ê¸‰ì‹ì´ ì—†ìŠµë‹ˆë‹¤.";
                    }
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('meal-box').innerText = "ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                });
        }
    </script>
</body>
</html>
